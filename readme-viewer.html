---
layout: default
title: README
---

<div class="post" id="readme-container">
  <p>正在加载README...</p>
</div>

<script>
  // 从URL参数获取仓库信息
  const urlParams = new URLSearchParams(window.location.search);
  const owner = urlParams.get('owner');
  const repo = urlParams.get('repo');
  const title = decodeURIComponent(urlParams.get('title') || repo);

  if (!owner || !repo) {
    document.getElementById('readme-container').innerHTML = '<p>参数错误，请返回。</p>';
  } else {
    // 设置页面标题
    document.title = title + ' · ' + (document.title.split(' · ')[1] || '');
    
    // 配置marked选项
    if (typeof marked !== 'undefined') {
      marked.setOptions({
        breaks: true,
        gfm: true
      });
    }

    // 获取GitHub README
    async function fetchGitHubReadme(owner, repo) {
      try {
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/readme`, {
          headers: {
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // 获取仓库的默认分支
        const repoResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
          headers: {
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        const repoData = repoResponse.ok ? await repoResponse.json() : { default_branch: 'main' };
        const defaultBranch = repoData.default_branch || 'main';
        
        // 解码base64内容，正确处理UTF-8编码
        const base64Content = data.content.replace(/\s/g, '');
        const binaryString = atob(base64Content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        // 使用TextDecoder解码UTF-8
        let content = new TextDecoder('utf-8').decode(bytes);
        
        // 将相对路径的图片链接转换为GitHub raw链接
        const rawBaseUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${defaultBranch}`;
        content = content.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, path) => {
          // 如果已经是完整的URL
          if (path.startsWith('http://') || path.startsWith('https://')) {
            // 检查是否是GitHub blob链接，需要转换为raw链接
            if (path.includes('github.com/') && path.includes('/blob/')) {
              const rawPath = path.replace('/blob/', '/').replace('https://github.com/', 'https://raw.githubusercontent.com/');
              return `![${alt}](${rawPath})`;
            }
            return match;
          }
          // 相对路径，转换为GitHub raw链接
          // 移除开头的 ./ 或 ../ 或 /
          let cleanPath = path.replace(/^\.\//, '').replace(/^\.\.\//, '').replace(/^\//, '');
          // 处理URL编码的空格等特殊字符
          cleanPath = cleanPath.replace(/\s/g, '%20');
          return `![${alt}](${rawBaseUrl}/${cleanPath})`;
        });
        
        return {
          content: content,
          html_url: data.html_url,
          name: data.name,
          default_branch: defaultBranch
        };
      } catch (error) {
        console.error(`Error fetching README for ${owner}/${repo}:`, error);
        return null;
      }
    }

    // 渲染README内容
    function renderReadmeContent(readmeData, owner, repo) {
      // 渲染Markdown为HTML
      let htmlContent = '';
      if (typeof marked !== 'undefined') {
        htmlContent = marked.parse(readmeData.content);
      } else {
        htmlContent = `<pre>${readmeData.content}</pre>`;
      }

      // 创建临时容器来处理HTML中的图片链接
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlContent;
      
      // 修复HTML中所有img标签的src属性（处理已渲染的HTML中的相对路径）
      const images = tempDiv.querySelectorAll('img');
      const rawBaseUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${readmeData.default_branch || 'main'}`;
      images.forEach(img => {
        let src = img.getAttribute('src');
        if (!src) return;
        
        // 如果已经是完整的URL，检查是否是GitHub blob链接，需要转换为raw链接
        if (src.startsWith('https://github.com/') && src.includes('/blob/')) {
          // 将GitHub blob链接转换为raw链接
          src = src.replace('/blob/', '/').replace('https://github.com/', 'https://raw.githubusercontent.com/');
          img.setAttribute('src', src);
        }
        // 如果是相对路径（不以http开头）
        else if (!src.startsWith('http://') && !src.startsWith('https://')) {
          // 移除开头的 ./ 或 ../ 或 /
          let cleanPath = src.replace(/^\.\//, '').replace(/^\.\.\//, '').replace(/^\//, '');
          // 处理URL编码的空格等特殊字符
          cleanPath = cleanPath.replace(/\s/g, '%20');
          img.setAttribute('src', `${rawBaseUrl}/${cleanPath}`);
        }
      });
      
      return tempDiv.innerHTML;
    }

    // 加载README
    (async function() {
      const container = document.getElementById('readme-container');
      try {
        const readmeData = await fetchGitHubReadme(owner, repo);
        
        if (readmeData) {
          const htmlContent = renderReadmeContent(readmeData, owner, repo);
          container.innerHTML = `
            <h1 class="post-title">${title}</h1>
            <p class="post-meta">
              <a href="https://github.com/${owner}/${repo}" target="_blank">查看仓库 →</a>
            </p>
            <div class="github-readme-content">
              ${htmlContent}
            </div>
          `;
        } else {
          container.innerHTML = '<p>无法加载README，请检查仓库是否存在且为公开仓库。</p>';
        }
      } catch (error) {
        console.error('Error loading README:', error);
        container.innerHTML = '<p>加载README时出错，请稍后重试。</p>';
      }
    })();
  }
</script>
